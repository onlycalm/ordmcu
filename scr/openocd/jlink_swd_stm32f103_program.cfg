# ============================================
# STM32F103 简单可靠烧录脚本
# ============================================

source [find interface/jlink.cfg]
transport select swd
adapter speed 1000
source [find target/stm32f1x.cfg]

proc dump_flash {firmware_file} {
    echo "========================================"
    echo "STM32F103 可靠烧录 (已验证流程)"
    echo "文件: $firmware_file"
    echo "========================================"
    
    # 1. 初始化（与命令完全一致）
    init
    
    # 2. 复位并停止
    reset halt
    
    # 3. 擦除整个Flash
    flash erase_sector 0 0 last
    
    # 4. 烧录文件（自动识别格式）
    set file_ext [file extension $firmware_file]
    
    if {$file_ext == ".bin"} {
        # BIN文件需要指定地址
        program $firmware_file 0x08000000 verify
    } elseif {$file_ext == ".hex" || $file_ext == ".elf"} {
        # HEX/ELF文件自带地址信息
        program $firmware_file verify
    } else {
        echo "错误: 不支持的文件格式 '$file_ext'"
        shutdown
        return -1
    }
    
    echo "烧录验证成功"
    
    # 5. 执行复位（关键步骤）
    reset run
    
    # 6. 等待复位完成（关键参数：1500ms）
    echo "等待复位完成 (1500ms)..."
    after 1500
    
    echo "烧录完成，芯片已复位"
    echo "========================================"
    
    shutdown
    return 0
}
