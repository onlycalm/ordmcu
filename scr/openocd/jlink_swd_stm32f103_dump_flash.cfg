# ============================================
# STM32F103 Flash读取
# ============================================

source [find interface/jlink.cfg]
transport select swd
adapter speed 4000
source [find target/stm32f1x.cfg]
reset_config none

# 设置输出文件名
set output_file "read_flash.bin"

# 主程序
proc read_flash_clean {} {
    global output_file

    echo "开始读取STM32F103 Flash..."

    # 初始化
    init
    reset init
    halt
    sleep 100

    # 直接读取整个Flash（512KB）
    echo "正在读取Flash到: $output_file"
    echo "大小: 512KB (0x08000000 - 0x0807FFFF)"

    # 删除旧文件（如果存在）
    catch {file delete $output_file}

    # 读取整个Flash
    dump_image $output_file 0x08000000 0x80000

    # 验证读取
    if {[file exists $output_file]} {
        set file_size [file size $output_file]
        echo "读取完成!"
        echo "文件大小: $file_size 字节 ([expr $file_size/1024] KB)"

        if {$file_size == 0x80000} {
            echo "读取成功: $output_file"
            echo ""

            # 使用外部命令查看文件头（兼容性更好）
            echo "使用外部命令检查文件头:"
            catch {
                # 使用hexdump命令（如果可用）
                exec sh -c "hexdump -C -n 64 $output_file 2>/dev/null || xxd -g 1 -l 64 $output_file 2>/dev/null || od -x -N 64 $output_file 2>/dev/null"
            }

        } else {
            echo "警告: 文件大小不正确"
        }
    } else {
        echo "错误: 文件创建失败"
    }

    # 恢复芯片运行
    reset run
    echo "芯片已复位运行"
}

# 执行读取
read_flash_clean

# 关闭连接
shutdown
