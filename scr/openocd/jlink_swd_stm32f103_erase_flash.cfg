# ============================================
# STM32F103ZET6 全片擦除配置文件（J-Link + SWD）
# 支持无 nSRST 连接情况
# ============================================

# 使用 J-Link 调试器
source [find interface/jlink.cfg]

# 选择 SWD 传输模式
transport select swd

# 设置 SWD 时钟频率（单位：kHz），STM32F1 支持最高约 4000 kHz
adapter speed 4000

# 目标芯片配置
source [find target/stm32f1x.cfg]

# ==================================================================================
# 复位配置说明：
# - 如果你没有将 J-Link 的 nSRST 接到 STM32 的 NRST 引脚，请使用 `reset_config none`
# - 否则可使用 `reset_config srst_only srst_open_drain` 等
# ==================================================================================
reset_config none

# 可选：启用软复位支持（通过 AIRCR 触发 Cortex-M 复位）
adapter srst delay 100
adapter srst pulse_width 100

# ==================================================================================
# 擦除主程序函数
# ==================================================================================
proc erase_chip {} {
    echo "开始擦除 STM32F103ZET6 ..."

    # 初始化调试会话
    init

    # 尝试复位并进入 halt 状态
    echo "尝试复位并暂停 CPU..."
    catch {reset init} err
    if {[string first "timed out" $err] != -1 || [string first "Error" $err] != -1} {
        echo "reset init 失败，尝试手动 halt..."
        
        # 如果 reset init 失败，尝试强制 halt
        catch {halt}
        if {[target cur_state] != "halted"} {
            echo "错误：无法暂停 CPU，请检查供电、BOOT 模式或保护位！"
            shutdown
            return -1
        }
    }

    # 等待稳定
    sleep 100

    # 执行全片擦除（mass erase）
    echo "执行全片擦除..."
    set res [catch {stm32f1x mass_erase 0} result]
    if {$res == 0} {
        echo "全片擦除成功！"
    } else {
        echo "全片擦除失败: $result"
        echo "尝试逐扇区擦除..."
        for {set i 0} {$i < 64} {incr i} {
            echo "擦除扇区 $i..."
            flash erase_sector 0 $i $i
        }
    }

    # 最终复位并运行
    echo "复位并启动芯片..."
    reset run

    echo "擦除完成！"
}

# 执行擦除操作
erase_chip

# 关闭连接
shutdown
